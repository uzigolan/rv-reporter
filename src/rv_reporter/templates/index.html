{% extends "layout.html" %}
{% block title %}Generate Report | RV Reporter{% endblock %}
{% block content %}
<section class="panel hero">
  <h1>Tabular File to Structured Report</h1>
  <p>Generate schema-validated JSON and polished HTML from your dataset.</p>
</section>

<section class="panel">
  <form method="post" action="{{ url_for('generate') }}" enctype="multipart/form-data" class="grid" id="generate_form">
    <input type="hidden" name="attempt_id" id="attempt_id" value="" />
    <input type="hidden" name="existing_csv_path" id="existing_csv_path" value="{{ existing_csv_path or '' }}" />
    <div class="form-row form-row-top">
      <label>
        <span>Report Type</span>
        <select name="report_type_id" required>
          {% for rt in report_type_options %}
            <option value="{{ rt.id }}" {% if rt.id == defaults.report_type_id %}selected{% endif %}>{{ rt.label }}</option>
          {% endfor %}
        </select>
        <span class="field-help">Select the analysis blueprint. Each report type defines required columns, computed metrics, and the final output structure.</span>
      </label>

      <label>
        <span>Provider</span>
        <select name="provider" id="provider" required>
          {% for p in provider_options %}
            <option value="{{ p.id }}" {% if defaults.provider == p.id %}selected{% endif %}>{{ p.label }}</option>
          {% endfor %}
        </select>
        <span class="field-help">Choose inference engine. local runs deterministic metrics only. API providers use token-authenticated LLM generation.</span>
      </label>

      <label id="model_wrap">
        <span>Model / cost ratio</span>
        <select name="model" id="model_select">
          {% for opt in model_options %}
            <option value="{{ opt.value }}" {% if opt.value == defaults.model %}selected{% endif %}>{{ opt.label }}</option>
          {% endfor %}
        </select>
        <span class="field-help">Model id used by selected provider. Ratio is calculated against gpt-5-mini (1x baseline).</span>
      </label>
      <label id="upload_wrap" class="upload-field">
        <span>Upload File</span>
        <div id="upload_input_row" style="display:flex; gap:.5rem; align-items:center; flex-wrap:nowrap; width:100%;">
          <select id="upload_mode" style="width: 8.75rem; flex: 0 0 8.75rem;">
            <option value="new">New file</option>
            <option value="recent" selected>Recent file</option>
          </select>
          <div id="new_upload_row" style="flex:1 1 auto; min-width: 0;">
            <input type="file" name="csv_upload" id="csv_upload" accept=".csv,.xlsx,.xls,.pcap,.pcapng" style="width:100%; max-width:24rem;" />
          </div>
          <div id="recent_upload_row" class="hidden" style="flex:1 1 auto; min-width: 0;">
            <select id="recent_upload_select" style="width:100%; max-width:24rem; min-width:0;">
            <option value="">Choose recent upload...</option>
            {% for recent in recent_uploads %}
              <option value="{{ recent }}">{{ recent.split('\\')[-1].split('/')[-1] }}</option>
            {% endfor %}
          </select>
          </div>
        </div>
        <span class="field-help">Upload CSV, Excel, or Wireshark capture (.pcap/.pcapng). For Excel files, sheet names are discovered automatically after selection.</span>
      </label>

      <label id="sheet_wrap">
        <span>Sheet (for .xlsx/.xls)</span>
        <select name="sheet_name" id="sheet_name">
          {% if not sheet_options %}
            <option value="">Auto / not needed</option>
          {% endif %}
          {% for sheet in sheet_options %}
            <option value="{{ sheet }}" {% if selected_sheet == sheet %}selected{% endif %}>{{ sheet }}</option>
          {% endfor %}
        </select>
        <span class="field-help">For Excel inputs, choose the sheet to analyze. If only one sheet exists, it is selected automatically.</span>
      </label>
    </div>

    <input type="hidden" name="api_base_url" id="api_base_url" value="{{ defaults.api_base_url or '' }}" />

    <div class="form-row form-row-3">
      <label>
        <span>Tone</span>
        <select name="tone">
          <option value="concise">concise</option>
          <option value="executive">executive</option>
          <option value="technical">technical</option>
        </select>
        <span class="field-help">Defines writing style and depth.<br><strong>concise:</strong> short and direct summary.<br><strong>executive:</strong> business impact and decisions.<br><strong>technical:</strong> deeper analysis and details.</span>
      </label>

      <label>
        <span>Audience</span>
        <select name="audience">
          <option value="leadership">leadership</option>
          <option value="engineering">engineering</option>
          <option value="customer">customer</option>
        </select>
        <span class="field-help">Defines who the report is written for.<br><strong>leadership:</strong> risk, impact, and priorities.<br><strong>engineering:</strong> root cause and actions.<br><strong>customer:</strong> service quality and outcomes.</span>
      </label>

      <label>
        <span>Focus</span>
        <select name="focus">
          <option value="trends">trends</option>
          <option value="anomalies">anomalies</option>
          <option value="cost">cost</option>
        </select>
        <span class="field-help">Defines what the report emphasizes most.<br><strong>trends:</strong> long-term behavior over time.<br><strong>anomalies:</strong> spikes and unusual intervals.<br><strong>cost:</strong> waste, efficiency, and savings.</span>
      </label>
    </div>

    <div class="form-row form-row-4">
      <label>
        <span>Threshold Key (optional)</span>
        <input name="threshold_name" placeholder="alert_error_rate or variance_alert_pct" />
        <span class="field-help">Optional preference key to override default alert logic. Use only known keys supported by this report type.</span>
      </label>

      <label>
        <span>Threshold Value (optional)</span>
        <input name="threshold_value" placeholder="0.05" />
        <span class="field-help">Numeric override for the selected threshold key. Example: `0.2` for 20% when the metric is ratio-based.</span>
      </label>

      <label>
        <span>Row Limit (cost control)</span>
        <input name="row_limit" type="number" min="1" step="1" value="{{ defaults.row_limit }}" />
        <span class="field-help">Maximum number of rows loaded from input. Lower values reduce cost and time; higher values improve coverage.</span>
      </label>

      <label>
        <span>Output Tokens Budget</span>
        <input name="output_token_budget" type="number" min="1" step="1" value="1200" />
        <span class="field-help">Estimated response size used for cost preview. Increase if you expect longer reports with more narrative.</span>
      </label>
    </div>

    <button type="submit" class="btn-primary generate-btn-row" id="generate_submit_btn">Generate Report</button>
    <p id="generate_processing_msg" class="processing-msg hidden">
      <span class="spinner" aria-hidden="true"></span>
      Processing request. This may take several seconds...
    </p>
  </form>
</section>
<div id="help_popup" class="help-popup hidden" role="tooltip" aria-live="polite">
  <div class="help-popup-card">
    <h3 id="help_popup_title">Field Help</h3>
    <p id="help_popup_body" class="help-popup-body"></p>
  </div>
</div>

<script>
  const reportTypeInput = document.querySelector("select[name='report_type_id']");
  const provider = document.getElementById("provider");
  const modelWrap = document.getElementById("model_wrap");
  const modelSelect = document.getElementById("model_select");
  const apiBaseUrlInput = document.getElementById("api_base_url");
  const uploadWrap = document.getElementById("upload_wrap");
  const uploadMode = document.getElementById("upload_mode");
  const newUploadRow = document.getElementById("new_upload_row");
  const recentUploadRow = document.getElementById("recent_upload_row");
  const uploadInput = document.getElementById("csv_upload");
  const recentUploadSelect = document.getElementById("recent_upload_select");
  const sheetWrap = document.getElementById("sheet_wrap");
  const sheetInput = document.getElementById("sheet_name");
  const existingCsvPathInput = document.getElementById("existing_csv_path");
  const attemptIdInput = document.getElementById("attempt_id");
  const STORAGE_KEY = "rv_reporter.generate_form_state.v1";
  const PROVIDER_MODEL_OPTIONS = {{ provider_model_options|tojson }};
  const PROVIDER_IDS = {{ provider_ids|tojson }};
  let currentSourceFileType = "unknown";

  const saveState = () => {
    const state = {
      provider: provider.value,
    };
    try { sessionStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch (e) {}
  };

  const restoreState = () => {
    try {
      const raw = sessionStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      const state = JSON.parse(raw);
      if (PROVIDER_IDS.includes(state.provider)) {
        provider.value = state.provider;
      }
    } catch (e) {}
  };
  const syncProviderUi = () => {
    const isLocal = provider.value === "local";
    modelWrap.classList.toggle("field-disabled", isLocal);
    modelSelect.disabled = isLocal;
    if (isLocal) {
      apiBaseUrlInput.value = "";
    }
  };
  const syncUploadModeUi = () => {
    const recentMode = uploadMode && uploadMode.value === "recent";
    if (newUploadRow) {
      newUploadRow.classList.toggle("hidden", recentMode);
    }
    if (recentUploadRow) {
      recentUploadRow.classList.toggle("hidden", !recentMode);
    }
    if (uploadInput) {
      uploadInput.disabled = recentMode;
    }
    if (recentUploadSelect) {
      recentUploadSelect.disabled = !recentMode;
    }
    if (!recentMode && recentUploadSelect) {
      recentUploadSelect.value = "";
    }
    if (recentMode && uploadInput) {
      uploadInput.value = "";
    }
  };
  const setModelOptions = (options, previousValue) => {
    const normalized = options || [];
    modelSelect.innerHTML = "";
    for (const opt of normalized) {
      const option = document.createElement("option");
      option.value = String((typeof opt === "string" ? opt : opt.value) || "");
      option.textContent = String((typeof opt === "string" ? opt : (opt.label || opt.value)) || option.value);
      modelSelect.appendChild(option);
    }
    if (provider.value === "local") {
      modelSelect.value = "local-metrics";
      return;
    }
    if (previousValue) {
      const values = normalized.map((o) => typeof o === "string" ? String(o) : String(o.value || ""));
      if (values.includes(previousValue)) {
        modelSelect.value = previousValue;
        return;
      }
    }
    if (modelSelect.options.length > 0) {
      modelSelect.selectedIndex = 0;
    }
  };
  const refreshProviderModels = async () => {
    const previousValue = modelSelect.value;
    const fallbackOptions = PROVIDER_MODEL_OPTIONS[provider.value] || [];
    if (provider.value === "local") {
      setModelOptions([{ value: "local-metrics", label: "local-metrics / 0x" }], previousValue);
      return;
    }
    try {
      const params = new URLSearchParams({
        provider: provider.value,
        api_key: "",
        api_base_url: (apiBaseUrlInput && apiBaseUrlInput.value) ? apiBaseUrlInput.value : "",
      });
      const response = await fetch(`{{ url_for('provider_models') }}?${params.toString()}`);
      if (!response.ok) {
        setModelOptions(fallbackOptions, previousValue);
        return;
      }
      const payload = await response.json();
      if (payload && Array.isArray(payload.options) && payload.options.length > 0) {
        setModelOptions(payload.options, previousValue);
      } else {
        setModelOptions(fallbackOptions, previousValue);
      }
    } catch (e) {
      setModelOptions(fallbackOptions, previousValue);
    }
  };
  const syncSheetUi = () => {
    const isExcel = currentSourceFileType === "excel";
    sheetWrap.classList.toggle("field-disabled", !isExcel);
    sheetInput.disabled = !isExcel;
    if (!isExcel) {
      sheetInput.value = "";
    }
  };
  const populateSheetOptions = (sheets) => {
    const current = sheetInput.value;
    const list = sheets || [];
    sheetInput.innerHTML = "";
    if (list.length === 0) {
      sheetInput.innerHTML = '<option value="">Auto / not needed</option>';
      return;
    }
    for (const sheet of list) {
      const option = document.createElement("option");
      option.value = sheet;
      option.textContent = sheet;
      if (sheet === current) {
        option.selected = true;
      }
      sheetInput.appendChild(option);
    }
    if (!current && list.length > 0) {
      sheetInput.value = list[0];
    }
  };
  const fetchSourceMetadata = async (pathValue, sheetValue) => {
    if (!pathValue) {
      currentSourceFileType = "unknown";
      populateSheetOptions([]);
      syncSheetUi();
      return;
    }
    try {
      const url = `{{ url_for('source_metadata') }}?path=${encodeURIComponent(pathValue)}&sheet_name=${encodeURIComponent(sheetValue || "")}`;
      const response = await fetch(url);
      if (!response.ok) return;
      const payload = await response.json();
      currentSourceFileType = String(payload.file_type || "unknown");
      if (payload.file_type === "excel") {
        populateSheetOptions(payload.sheets || []);
        if (payload.selected_sheet) {
          sheetInput.value = payload.selected_sheet;
        } else if ((payload.sheets || []).length <= 1) {
          sheetInput.value = "";
        }
      } else {
        populateSheetOptions([]);
      }
      syncSheetUi();
    } catch (e) {}
  };
  reportTypeInput.addEventListener("change", () => {
    const activePath = existingCsvPathInput.value;
    fetchSourceMetadata(activePath, sheetInput.value);
    saveState();
  });
  provider.addEventListener("change", () => {
    syncProviderUi();
    refreshProviderModels();
    saveState();
  });
  if (apiBaseUrlInput) {
    apiBaseUrlInput.addEventListener("input", () => { refreshProviderModels(); });
    apiBaseUrlInput.addEventListener("change", () => { refreshProviderModels(); });
  }
  sheetInput.addEventListener("change", () => {
    const activePath = existingCsvPathInput.value;
    fetchSourceMetadata(activePath, sheetInput.value);
    saveState();
  });
  uploadInput.addEventListener("change", () => {
    if (uploadInput.files && uploadInput.files.length > 0) {
      existingCsvPathInput.value = "";
      if (recentUploadSelect) recentUploadSelect.value = "";
      const selectedFile = uploadInput.files[0];
      const data = new FormData();
      data.append("file", selectedFile);
      fetch("{{ url_for('upload_source_metadata') }}", { method: "POST", body: data })
        .then((response) => response.json())
        .then((payload) => {
          if (!payload) return;
          if (payload.path) {
            existingCsvPathInput.value = payload.path;
          }
          if (payload.file_type === "excel") {
            currentSourceFileType = "excel";
            populateSheetOptions(payload.sheets || []);
            if (payload.selected_sheet) {
              sheetInput.value = payload.selected_sheet;
            }
          } else {
            currentSourceFileType = "csv";
            populateSheetOptions([]);
          }
          syncSheetUi();
        })
        .catch(() => {});
    }
  });
  if (uploadMode) {
    uploadMode.addEventListener("change", () => {
      syncUploadModeUi();
      if (uploadMode.value !== "recent") {
        if (existingCsvPathInput.value && uploadInput && uploadInput.files && uploadInput.files.length === 0) {
          existingCsvPathInput.value = "";
          sheetInput.value = "";
          populateSheetOptions([]);
          syncSheetUi();
        }
      }
    });
  }
  if (recentUploadSelect) {
    recentUploadSelect.addEventListener("change", () => {
      const path = recentUploadSelect.value || "";
      if (!path) return;
      existingCsvPathInput.value = path;
      if (uploadInput) uploadInput.value = "";
      fetchSourceMetadata(path, sheetInput.value);
    });
  }
  window.addEventListener("pageshow", () => {
    restoreState();
    syncProviderUi();
    refreshProviderModels();
    resetGenerateUi();
  });
  restoreState();
  syncProviderUi();
  syncUploadModeUi();
  refreshProviderModels();
  syncSheetUi();
  if (existingCsvPathInput.value) {
    fetchSourceMetadata(existingCsvPathInput.value, sheetInput.value);
  }

  const generateForm = document.getElementById("generate_form");
  const generateBtn = document.getElementById("generate_submit_btn");
  const generateMsg = document.getElementById("generate_processing_msg");
  const resetGenerateUi = () => {
    generateBtn.disabled = false;
    generateBtn.textContent = "Generate Report";
    generateMsg.classList.add("hidden");
    generateForm.classList.remove("is-loading");
  };
  const helpPopup = document.getElementById("help_popup");
  const helpPopupTitle = document.getElementById("help_popup_title");
  const helpPopupBody = document.getElementById("help_popup_body");
  let activeHelpButton = null;
  const showHelpPopup = (anchorEl, title, text) => {
    helpPopupTitle.textContent = title || "Field Help";
        helpPopupBody.innerHTML = text || "";
    helpPopup.classList.remove("hidden");
    const rect = anchorEl.getBoundingClientRect();
    const top = window.scrollY + rect.bottom + 8;
    const left = window.scrollX + rect.left - 12;
    helpPopup.style.top = `${top}px`;
    helpPopup.style.left = `${Math.max(12, left)}px`;
  };
  const hideHelpPopup = () => {
    if (activeHelpButton) {
      activeHelpButton.setAttribute("aria-expanded", "false");
      activeHelpButton = null;
    }
    helpPopup.classList.add("hidden");
  };
  const setupHelpToggles = () => {
    const labels = Array.from(generateForm.querySelectorAll("label"));
    for (const label of labels) {
      const help = label.querySelector(".field-help");
      if (!help) continue;
      const titleSpan = label.querySelector("span:not(.field-help)");
      if (!titleSpan) continue;
      titleSpan.classList.add("label-row");
      const button = document.createElement("span");
      button.className = "help-toggle";
      button.textContent = "i";
      button.setAttribute("role", "button");
      button.setAttribute("tabindex", "0");
      button.setAttribute("aria-label", "Show field help");
      button.setAttribute("aria-expanded", "false");
      const title = (titleSpan.childNodes[0] && titleSpan.childNodes[0].nodeValue ? titleSpan.childNodes[0].nodeValue : "Field Help").trim();
      const text = help.innerHTML.trim();
      button.addEventListener("click", (event) => {
        event.preventDefault();
        event.stopPropagation();
        const alreadyOpen = !helpPopup.classList.contains("hidden") && activeHelpButton === button;
        if (alreadyOpen) {
          hideHelpPopup();
          return;
        }
        hideHelpPopup();
        activeHelpButton = button;
        button.setAttribute("aria-expanded", "true");
        showHelpPopup(button, title, text);
      });
      button.addEventListener("keydown", (event) => {
        if (event.key !== "Enter" && event.key !== " ") return;
        event.preventDefault();
        button.click();
      });
      titleSpan.appendChild(button);
    }
  };
  setupHelpToggles();
  document.addEventListener("click", (event) => {
    if (event.target && event.target.closest(".help-toggle")) return;
    hideHelpPopup();
  });
  document.addEventListener("keydown", (event) => {
    if (event.key === "Escape") hideHelpPopup();
  });
  resetGenerateUi();
  generateForm.addEventListener("submit", () => {
    saveState();
    const attemptId = `evt_${Math.random().toString(36).slice(2, 12)}`;
    attemptIdInput.value = attemptId;
    if (window.rvGenerationState && typeof window.rvGenerationState.startJob === "function") {
      const jobId = window.rvGenerationState.startJob(attemptId, "Generating report...");
      try { sessionStorage.setItem("rv_current_job_id", jobId); } catch (e) {}
    }
    generateBtn.disabled = true;
    generateBtn.textContent = "Working...";
    generateMsg.classList.remove("hidden");
    generateForm.classList.add("is-loading");
  });
</script>
{% endblock %}
